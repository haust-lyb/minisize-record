name: Build and Release

# 触发条件：
# - push 到 main/master/develop 分支
# - 提交 PR 到 main/master 分支
# - 手动触发 workflow_dispatch
on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# ============================================
# 构建作业 - macOS
# ============================================
jobs:
  build-macos:
    runs-on: macos-latest  # 在 macOS 虚拟机上运行

    # 矩阵策略：同时构建 x64 和 arm64 版本
    strategy:
      matrix:
        include:
          - arch: x64      # Intel Mac
          - arch: arm64    # Apple Silicon Mac

    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.17.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build macOS app
        run: npm run build -- --mac --${{ matrix.arch }} --publish=never
        env:
          # 禁用代码签名（免费账户无签名证书）
          CSC_IDENTITY_AUTO_DISCOVERY: false

      # 步骤6：上传构建产物
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-build  # 产物名称（区分架构）
          path: dist/                           # 上传 dist 目录
          retention-days: 7                     # 7天后自动删除（节省存储）

# ============================================
# 构建作业 - Windows
# ============================================
  build-windows:
    runs-on: windows-latest  # 在 Windows 虚拟机上运行

    # 矩阵策略：同时构建三种架构
    strategy:
      matrix:
        include:
          - arch: x64      # 64位 Windows（主流）
          - arch: ia32     # 32位 Windows（旧设备）
          - arch: arm64    # Windows on ARM（Surface Pro X 等）

    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.17.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Windows app
        run: npm run build -- --win --${{ matrix.arch }} --publish=never
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      # 步骤6：上传构建产物
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}-build
          path: dist/
          retention-days: 7

# ============================================
# 发布作业
# 只有打标签时才会触发（如 v1.0.0）
# ============================================
  release:
    needs: [build-macos, build-windows]  # 等待所有构建作业完成
    runs-on: ubuntu-latest               # 在 Ubuntu 上运行（免费）
    if: startsWith(github.ref, 'refs/tags/')  # 仅打标签时触发

    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：下载所有构建产物
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true  # 合并到一个目录

      # 步骤3：创建 GitHub Release 并上传文件
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          # 上传所有平台的安装包
          files: |
            artifacts/*.dmg
            artifacts/*.zip
            artifacts/*.exe
            artifacts/*.msi
          draft: false          # 直接发布（非草稿）
          prerelease: false     # 正式版（非预发布）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 自动获取 Token
